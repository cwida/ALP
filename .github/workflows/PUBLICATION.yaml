name: CI
run-name: ${{ github.actor }} is building the publication CI

on: push

jobs:
  build_paper:
    strategy:
      fail-fast: true
      matrix:
        platform: [ ubuntu-latest, macos-latest, avx512 ]
        BUILD_TYPE: [ Release ]
        cc: [ clang ]
        cxx: [ clang++ ]
    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4

      - name: mkdir build
        run: mkdir ${{github.workspace}}/build

      - name: Configure CMake
        run: cmake -DALP_BUILD_PUBLICATION=ON -S ${{github.workspace}} -B ${{github.workspace}}/build
        env:
          CXX: ${{ matrix.cxx }}

      - name: Build
        run: cmake --build ${{github.workspace}}/build -j 16

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: ctest -j 4

      - name: Check if ALP_DATASET_DIR_PATH is set and print download link
        run: |
          if [ -z "${ALP_DATASET_DIR_PATH}" ]; then
            echo -e "\033[33mPlease download the dataset from: https://drive.google.com/drive/folders/167faTwZJjqJMKM9Yc6E7KF5LUbsitxJS?usp=sharing\033[0m"
            echo -e "\033[33mWarning: ALP_DATASET_DIR_PATH is not set!\033[0m"
            exit 1  # Fail the workflow
          else
            echo "ALP_DATASET_DIR_PATH is set to ${ALP_DATASET_DIR_PATH}"
          fi

      - name: run compression ratio alp
        run: ${{github.workspace}}/build/b/publication/source_code/bench_compression_ratio/bench_alp_compression_ratio

      - name: run compression ratio alp32
        run: ${{github.workspace}}/build/b/publication/source_code/bench_compression_ratio/bench_alp32_compression_ratio

      - name: run compression ratio zstd
        run: ${{github.workspace}}/build/b/publication/source_code/bench_compression_ratio/bench_zstd_compression_ratio
      - name: run bench_alp_cutter_decode
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_alp_cutter_decode

      - name: run bench_alp_cutter_encode
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_alp_cutter_encode

      - name: run bench_alp_encode
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_alp_encode

      - name: run bench_alp_without_sampling
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_alp_without_sampling

      - name: run bench_chimp
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_chimp

      - name: run bench_chimp128
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_chimp128

      - name: run bench_gorillas
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_gorillas

      - name: run bench_patas
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_patas

      - name: run bench_zstd
        run: ${{github.workspace}}/build/b/publication/source_code/bench/bench_zstd

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r publication/plotter/requirements.txt

      - name: Run plotter script
        run: python publication/plotter/plotter.py





